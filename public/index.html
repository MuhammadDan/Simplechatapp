<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Chat</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 24px auto; }
    #messages { list-style: none; padding: 0; }
    #messages li { margin: 6px 0; padding: 8px 10px; border-radius: 8px; background: #f5f5f5; }
    .me { background: #d7f7d7; }
    .meta { color: #666; font-size: 12px; margin-left: 4px; }
    .row { display: flex; gap: 8px; margin: 8px 0; }
    input { flex: 1; padding: 8px; }
    button { padding: 8px 12px; }
  </style>
</head>
<body>
  <h2>Chat App</h2>

  <div class="row">
    <input id="username" placeholder="Enter your name" />
    <button id="set-username">Set name</button>
  </div>

  <ul id="messages"></ul>

  <div class="row">
    <input id="m" autocomplete="off" placeholder="Type a message..." />
    <button id="send">Send</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let myName = localStorage.getItem("chat_username") || "";
    const usernameInput = document.getElementById("username");
    const messagesEl = document.getElementById("messages");
    const msgInput = document.getElementById("m");

    if (myName) usernameInput.value = myName;

    document.getElementById("set-username").onclick = () => {
      const name = usernameInput.value.trim();
      if (!name) return alert("Please enter a name.");
      myName = name;
      localStorage.setItem("chat_username", myName);
      alert("Name set: " + myName);
    };

    document.getElementById("send").onclick = () => {
      const text = msgInput.value.trim();
      const username = (myName || usernameInput.value || "Anonymous").trim();
      if (!text) return;
      socket.emit("chat message", { username, text });
      msgInput.value = "";
    };

    socket.on("chat message", (msg) => {
      const li = document.createElement("li");
      if (msg.sender === myName) li.classList.add("me");
      li.textContent = `${msg.sender}: ${msg.text}`;
      const meta = document.createElement("span");
      meta.className = "meta";
      meta.textContent = msg.createdAt ? ` • ${new Date(msg.createdAt).toLocaleTimeString()}` : "";
      li.appendChild(meta);
      messagesEl.appendChild(li);
    });

    // Optional: load recent messages
    fetch("/messages")
      .then((r) => r.json())
      .then((items) => {
        items.reverse().forEach((m) => {
          const li = document.createElement("li");
          if (m.username === myName) li.classList.add("me");
          li.textContent = `${m.username}: ${m.text}`;
          const meta = document.createElement("span");
          meta.className = "meta";
          meta.textContent = m.createdAt ? ` • ${new Date(m.createdAt).toLocaleTimeString()}` : "";
          li.appendChild(meta);
          messagesEl.appendChild(li);
        });
      })
      .catch(() => {});
  </script>
</body>
</html>